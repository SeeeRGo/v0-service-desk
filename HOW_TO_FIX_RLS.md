# Как исправить проблему с RLS политиками

## Проблема
Ошибка: "infinite recursion detected in policy for relation 'users'"

Это происходит потому что RLS политики для таблицы `users` пытаются проверить роль пользователя, обращаясь к самой таблице `users`, что создаёт бесконечную рекурсию.

## Решение

### Шаг 1: Откройте SQL редактор в Supabase
1. Перейдите в ваш проект Supabase
2. В левом меню выберите "SQL Editor"
3. Нажмите "New query"

### Шаг 2: Выполните скрипт
1. Скопируйте содержимое файла `scripts/007_fix_rls_final.sql`
2. Вставьте в SQL редактор
3. Нажмите кнопку "Run" или нажмите `Ctrl+Enter` / `Cmd+Enter`

### Шаг 3: Проверьте результат
После выполнения скрипта:
1. Перезагрузите страницу приложения
2. Попробуйте просмотреть список заявок
3. Ошибка "infinite recursion" должна исчезнуть

## Что делает скрипт?

1. **Удаляет** все старые проблемные политики
2. **Создаёт** новую функцию `auth_user_role()` которая получает роль из JWT токена, а не из таблицы
3. **Создаёт** новые политики без рекурсии:
   - Используют `auth.uid()` для проверки владельца
   - Используют `auth.jwt()` для получения роли из метаданных
   - НЕ обращаются к таблице `users` внутри политик

## Альтернативное решение (если скрипт не помог)

Если проблема сохраняется, можно временно отключить RLS для таблицы users:

\`\`\`sql
ALTER TABLE public.users DISABLE ROW LEVEL SECURITY;
\`\`\`

⚠️ **ВНИМАНИЕ**: Это сделает таблицу users доступной всем. Используйте только для тестирования!

## После исправления

После успешного выполнения скрипта система должна работать корректно:
- ✅ Список заявок загружается
- ✅ Создание новых заявок работает
- ✅ Пользователи видят только свои заявки (если они клиенты)
- ✅ Администраторы и супервизоры видят все заявки

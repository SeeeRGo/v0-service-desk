# Инструкция по настройке Service Desk системы

## Шаги для полного запуска системы

### 1. Выполните SQL скрипты в Supabase

Выполните скрипты в следующем порядке:

1. `scripts/001_create_tables.sql` - Создание таблиц базы данных
2. `scripts/005_fix_users_rls.sql` - Настройка Row Level Security (исправленная версия без рекурсии)
3. `scripts/006_fix_tickets_rls.sql` - Настройка RLS для заявок
4. `scripts/003_seed_data.sql` - Добавление начальных данных
5. `scripts/004_user_profile_trigger.sql` - Триггер для автоматического создания профиля

### 2. Проверьте переменные окружения

Убедитесь, что в вашем проекте установлены следующие переменные:
- `NEXT_PUBLIC_SUPABASE_URL`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- `NEXT_PUBLIC_DEV_SUPABASE_REDIRECT_URL` (для development)

### 3. Перелогиньтесь в системе

**ВАЖНО:** После выполнения SQL скриптов и исправления аутентификации:

1. Выйдите из системы (если вы залогинены)
2. Войдите заново используя форму `/auth/login`
3. Теперь сессия будет правильно установлена через Server Actions

### 4. Создайте первую заявку

После успешного входа:
1. Перейдите в раздел "Заявки"
2. Нажмите "Создать заявку"
3. Заполните форму и отправьте

## Устранение проблем

### Заявка не создается

**Причина:** Пользователь не авторизован или RLS политики блокируют запись.

**Решение:**
1. Откройте консоль браузера (F12)
2. Проверьте логи с префиксом `[v0]`
3. Убедитесь что `Auth user:` показывает ваш ID, а не `null`
4. Если показывает `null` - перелогиньтесь
5. Проверьте что выполнен скрипт `006_fix_tickets_rls.sql`

### Пользователь не отображается в sidebar

**Причина:** Ошибка в RLS политиках таблицы users (infinite recursion).

**Решение:**
1. Выполните скрипт `005_fix_users_rls.sql`
2. Перезагрузите страницу
3. Откройте консоль и проверьте логи

### Ошибка "Auth session missing"

**Причина:** Сессия не установлена через cookies.

**Решение:**
1. Полностью выйдите из системы
2. Очистите cookies (или используйте инкогнито)
3. Зарегистрируйтесь заново или войдите
4. Система теперь использует Server Actions для установки cookies

## Роли пользователей

- **client** - Клиент (может создавать и просматривать свои заявки)
- **engineer** - Инженер (может обрабатывать назначенные заявки)
- **supervisor** - Супервизор (может просматривать все заявки и назначать их)
- **admin** - Администратор (полный доступ ко всем функциям)

## Контакты для поддержки

При возникновении проблем проверьте:
1. Логи в консоли браузера (F12)
2. Логи в Supabase Dashboard → Logs
3. RLS политики в Supabase Dashboard → Authentication → Policies
